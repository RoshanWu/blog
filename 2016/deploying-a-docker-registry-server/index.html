<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8">
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>在 CentOS 7 上搭建 Docker 私有仓库 - 肉山·察</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0" />
  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>在 CentOS 7 上搭建 Docker 私有仓库 | 肉山·察</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="在 CentOS 7 上搭建 Docker 私有仓库" />
<meta property="og:locale" content="zh_Hans" />
<meta name="description" content="我们知道，执行 docker pull 某镜象，默认都是从 Docker Hub 的公共仓库去获取的。这有点像全球最大的代码托管商：Github。但对于公司企业而言，Maybe 更加需要是的自建的仓库服务，所以我们用自建的 Gitlab 代替 Github。那有什么可以替代 Docker Hub 呢？答案是：自建 Docker Registry。独自摸索了一阵子后，以下是自己的一点实践：" />
<meta property="og:description" content="我们知道，执行 docker pull 某镜象，默认都是从 Docker Hub 的公共仓库去获取的。这有点像全球最大的代码托管商：Github。但对于公司企业而言，Maybe 更加需要是的自建的仓库服务，所以我们用自建的 Gitlab 代替 Github。那有什么可以替代 Docker Hub 呢？答案是：自建 Docker Registry。独自摸索了一阵子后，以下是自己的一点实践：" />
<link rel="canonical" href="https://roshanca.com/2016/deploying-a-docker-registry-server/" />
<meta property="og:url" content="https://roshanca.com/2016/deploying-a-docker-registry-server/" />
<meta property="og:site_name" content="肉山·察" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-07-24T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="在 CentOS 7 上搭建 Docker 私有仓库" />
<meta name="twitter:site" content="@roshan_wu" />
<meta name="twitter:creator" content="@roshan_wu" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://roshanca.com/2016/deploying-a-docker-registry-server/"},"description":"我们知道，执行 docker pull 某镜象，默认都是从 Docker Hub 的公共仓库去获取的。这有点像全球最大的代码托管商：Github。但对于公司企业而言，Maybe 更加需要是的自建的仓库服务，所以我们用自建的 Gitlab 代替 Github。那有什么可以替代 Docker Hub 呢？答案是：自建 Docker Registry。独自摸索了一阵子后，以下是自己的一点实践：","headline":"在 CentOS 7 上搭建 Docker 私有仓库","dateModified":"2016-07-24T00:00:00+00:00","datePublished":"2016-07-24T00:00:00+00:00","@type":"BlogPosting","url":"https://roshanca.com/2016/deploying-a-docker-registry-server/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link href="/assets/styles/main.css" rel="stylesheet"><link type="application/atom+xml" rel="alternate" href="https://roshanca.com/feed.xml" title="肉山·察" /><link href="//cdn.bootcss.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    function loadSync(u,p,a){
      if(!p && location.port)return {onload: null};
      if(/\.js$/.test(u)){a='script'}else{a='link'};
      var d=document,s=d.createElement(a),f=d.getElementsByTagName(a)[0];
      if(a=='link'){s.href=u,s.rel='stylesheet'}else{s.src=u,s.async=true}
      f.parentNode.insertBefore(s,f);return s;
    }
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-15720258-1']);
    _gaq.push(['_trackPageview']);
    _gaq.push(['_trackPageLoadTime']);
    loadSync('//ssl.google-analytics.com/ga.js');
    if(/windows/i.test(navigator.userAgent)){document.getElementsByTagName('html')[0].className = 'windows'}
  </script>
  <!--[if lt IE 9]>
  <script>window.location.href="//browsehappy.com"</script>
  <![endif]-->
</head>

<body>
<header id="header" role="banner">
  
  <div class="header-inner">
    <a href="/" class="blog-title home">肉山·察</a>
    
    <div class="post-title">在 CentOS 7 上搭建 Docker 私有仓库</div>
    
    <div class="header-icon">
<a href="//github.com/roshanca" class="social-link">
  <i class="fa fa-github"></i>
</a>

<a href="//twitter.com/roshan_wu" class="social-link">
  <i class="fa fa-twitter"></i>
</a>

<a href="//www.instagram.com/roshanca/" class="social-link">
  <i class="fa fa-instagram"></i>
</a>

<a href="/feed.xml" class="social-link">
  <i class="fa fa-rss"></i>
</a>

</div>
  </div>
  <i class="author"></i>
  
</header>

<div class="scroll-view">
  <main class="fluid" role="main">
  <article class="post" role="article">
    <header class="post-header">
      <h1 class="post-title">在 CentOS 7 上搭建 Docker 私有仓库</h1>
    </header>
    <section class="post-content">
      <nav class="post-toc">
        <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#安装环境">安装环境</a></li>
<li class="toc-entry toc-h2"><a href="#docker-registry">Docker Registry</a>
<ul>
<li class="toc-entry toc-h3"><a href="#生成证书">生成证书</a></li>
<li class="toc-entry toc-h3"><a href="#安装-docker-registry-20">安装 Docker Registry 2.0</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#问题">问题</a>
<ul>
<li class="toc-entry toc-h3"><a href="#解决办法">解决办法：</a></li>
</ul>
</li>
</ul>
        <svg class="toc-marker" width="200" height="200" xmlns="http://www.w3.org/2000/svg">
          <path stroke="#444" stroke-width="3" fill="transparent" stroke-dasharray="0, 0, 0, 1000" stroke-linecap="round" stroke-linejoin="round"
            transform="translate(-0.5, -0.5)" />
        </svg>
      </nav>
      <p>我们知道，执行 docker pull 某镜象，默认都是从 <a href="https://hub.docker.com/">Docker Hub</a> 的公共仓库去获取的。这有点像全球最大的代码托管商：<a href="https://github.com/">Github</a>。但对于公司企业而言，Maybe 更加需要是的自建的仓库服务，所以我们用自建的 Gitlab 代替 Github。那有什么可以替代 Docker Hub 呢？答案是：自建 Docker Registry。独自摸索了一阵子后，以下是自己的一点实践：</p>

<h2 id="安装环境">
<a class="anchor" href="#%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83" aria-hidden="true"><span class="octicon octicon-link"></span></a>安装环境</h2>

<p>docker-engine 使用了最新的 1.11.2 版本。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@crh211 ~]# docker version
Client:
 Version:      1.11.2
 API version:  1.23
 Go version:   go1.5.4
 Git commit:   b9f10c9
 Built:        Wed Jun  1 21:23:11 2016
 OS/Arch:      linux/amd64

Server:
 Version:      1.11.2
 API version:  1.23
 Go version:   go1.5.4
 Git commit:   b9f10c9
 Built:        Wed Jun  1 21:23:11 2016
 OS/Arch:      linux/amd64
</code></pre></div></div>

<p>操作系统采用 CentOS 7, 内核 <code class="highlighter-rouge">3.10.0-229.el7.x86_64</code></p>

<h2 id="docker-registry">
<a class="anchor" href="#docker-registry" aria-hidden="true"><span class="octicon octicon-link"></span></a>Docker Registry</h2>

<p>一开始照着 <a href="https://yeasy.gitbooks.io/docker_practice/content/repository/local_repo.html">这里</a> 的教程安装了一下，发现在 push 镜象时，会报错。应该是跟 <code class="highlighter-rouge">https</code> 相关的问题，查阅了一下 <a href="https://docs.docker.com/registry/insecure/">官方资料</a>，依照提示想给 docker 启动增加参数：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DOCKER_OPTS="--insecure-registry myregistrydomain.com:5000"
</code></pre></div></div>

<p>但重启 docker 后好像没反应，试了好多种类似的方案都不行。看来要换种思路。一路找下去找到了 Docker Registry 2.0，抛弃了以上 insecure 的运行方式，采用了自建证书的认证方式。</p>

<h3 id="生成证书">
<a class="anchor" href="#%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6" aria-hidden="true"><span class="octicon octicon-link"></span></a>生成证书</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir -p certs &amp;&amp; openssl req \
  -newkey rsa:4096 -nodes -sha256 -keyout certs/domain.key \
  -x509 -days 365 -out certs/domain.crt

Country Name (2 letter code) [AU]:CN
State or Province Name (full name) [Some-State]:Zhengjiang
Locality Name (eg, city) []:Hangzhou
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Cairenhui
Organizational Unit Name (eg, section) []:FE
Common Name (e.g. server FQDN or YOUR name) []:192.168.1.211:5000
Email Address []:wuwj@cairenhui.com
</code></pre></div></div>

<p>接下来将刚生成的 <code class="highlighter-rouge">certs/domain.crt</code> 复制到 <code class="highlighter-rouge">/etc/docker/certs.d/192.168.1.211:5000/ca.crt</code>，并<strong>重启 docker</strong>。</p>

<h3 id="安装-docker-registry-20">
<a class="anchor" href="#%E5%AE%89%E8%A3%85-docker-registry-20" aria-hidden="true"><span class="octicon octicon-link"></span></a>安装 Docker Registry 2.0</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d -p 5000:5000 --restart=always --name registry \
  -v /root/certs:/certs \
  -v /opt/data:/var/lib/registry \
  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
  registry:2
</code></pre></div></div>

<h2 id="问题">
<a class="anchor" href="#%E9%97%AE%E9%A2%98" aria-hidden="true"><span class="octicon octicon-link"></span></a>问题</h2>

<p>安装完后在 push 镜象时还是遇到了一点小问题：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x509: cannot validate certificate for 192.168.1.211 because it doesn't contain any IP SANs
</code></pre></div></div>

<h3 id="解决办法">
<a class="anchor" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95" aria-hidden="true"><span class="octicon octicon-link"></span></a>解决办法：</h3>

<p>修改 <code class="highlighter-rouge">/etc/pki/tls/openssl.cnf</code> 配置，在该文件中找到 <code class="highlighter-rouge">[ v3_ca ]</code>，在它下面添加如下内容：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ v3_ca ]
# Extensions for a typical CA
subjectAltName = IP:192.168.1.211
</code></pre></div></div>

<p>再次重启 docker，问题解决。</p>

<p>至此，<code class="highlighter-rouge">docker registry</code> 私有仓库安装成功。接下来可以随时登录公司的 VPN 去 pull 镜象了。</p>

    </section>
    <footer class="post-footer">
      <div class="post-meta">
        <a href="" rel="full-article"><time datetime="2016-07-24 00:00:00 +0000" class="updated" pubdate>Jul 24, 2016</time></a>

        
<span class="post-tag">
  
  <a class="tag" href="/archives/tag/docker">docker</a>
  
  <a class="tag" href="/archives/tag/centos">centos</a>
  
</span>


      </div>
    </footer>
    <section class="post-recent">
  
  <i class="fa fa-angle-double-left"></i>
  <a class="relative-post previous" href="/2015/write-a-simple-snake-game-with-typescript/"
    ><span>用 TypeScript 写一个贪食蛇小游戏</span></a
  >
   
  <a class="relative-post next" href="/2016/node-app-deploy-simple-guide/"
    ><span>Node APP 布署简易教程</span></a
  >
  <i class="fa fa-angle-double-right"></i>
  
</section>

  </article>
  
    <div class="post-comment">
  <div id="disqus_thread" class="container"></div>
</div>
<script>
  function getElementTopLeft(elem) {
    var top = 0
    var left = 0
    while (elem) {
      top += elem.offsetTop
      left += elem.offsetLeft

      elem = elem.offsetParent
    }
    return { top: top, left: left }
  }

  var disqus_shortname = 'roshanca'
  var disqus_elem = document.getElementById('disqus_thread')
  var disqus_init = false

  document.querySelector('.scroll-view').addEventListener('scroll', (evt) => {
    if (disqus_init) return

    var viewHeight = document.documentElement.clientHeight
    var scrollY = (evt.target || evt.srcElement).scrollTop

    if (getElementTopLeft(disqus_elem).top < viewHeight + scrollY) {
      loadSync('//' + disqus_shortname + '.disqus.com/embed.js')
      disqus_init = true
    }
  }, false)
</script>

  
</main>

  <footer id="footer" role="contentinfo">
  <p>
    © Copyright 2012 -
    <script>
      document.write(new Date().getFullYear())
    </script>
  </p>
</footer>

<script src="/assets/scripts/anchor.min.js"></script>
<script src="/assets/scripts/toc.js"></script>

<script src="/assets/scripts/common.js"></script>

</div>
</body>
</html>